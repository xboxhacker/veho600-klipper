######################################################################
# G28: Home all axes, heat bed, soak, probe, set Z=0 at detected surface,
#      apply fine-tune offset for ideal paper test
######################################################################

[gcode_macro G28]
description: Home all axes, heat bed, soak, probe, set Z=0 at detected surface, apply fine offset
rename_existing: G28.1

variable_probe_speed_mms: 3.0    # Slow PROBE speed (mm/s)
variable_bed_temp_c: 70          # Bed target temp (C); set 0 to skip heating
variable_soak_seconds: 60        # Extra soak time after bed reaches temp
variable_z_offset: -0.22          # Fine-tune offset (default -0.3mm; override with G28 ZOFFSET=...)

gcode:
    {% set bed_t    = (params.BED    | default(printer["gcode_macro G28"].bed_temp_c))      | int %}
    {% set soak_s   = (params.SOAK   | default(printer["gcode_macro G28"].soak_seconds))    | int %}
    {% set probe_spd= (params.SPEED  | default(printer["gcode_macro G28"].probe_speed_mms)) | float %}
    {% set z_offset = (params.ZOFFSET| default(printer["gcode_macro G28"].z_offset))        | float %}

    BED_MESH_CLEAR

    # Start heating bed immediately
    {% if bed_t > 0 %}
      M117 Heating bed to {bed_t}C
      M140 S{bed_t}
    {% endif %}

    # Home X, Y, Z
    G28.1 X
    G28.1 Y
    G28.1 Z

    # Wait for bed to reach temp and soak
    {% if bed_t > 0 %}
      M190 S{bed_t}
      {% if soak_s > 0 %}
        M117 Soaking at {bed_t}C for {soak_s}s
        G4 S{soak_s}
      {% endif %}
    {% endif %}

    # Move to bed center
    {% set cx = (printer.toolhead.axis_minimum.x + printer.toolhead.axis_maximum.x) / 2.0 %}
    {% set cy = (printer.toolhead.axis_minimum.y + printer.toolhead.axis_maximum.y) / 2.0 %}
    G90
    G1 X{cx} Y{cy} F12000

    # Safe height
    G1 Z10 F1000

    # Clear prior offset
    SET_GCODE_OFFSET Z=0 MOVE=0

    # Probe bed (BDsensor triggers at surface)
    PROBE SPEED={probe_spd}

    # Set Z=0 at current location (the surface found)
    SET_KINEMATIC_POSITION Z=0

    # Fine-tune: apply your extra offset (default -0.3mm)
    SET_GCODE_OFFSET Z_ADJUST={z_offset} MOVE=0
    M117 G28 done: Applied fine offset {z_offset}mm
